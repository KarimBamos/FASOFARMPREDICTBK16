<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√©t√©o Burkina Faso - FasoFarmPredict</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e0f2f1;
    }
    .header-image {
      width: 100%;
      height: 300px;
      background: url("images/meteo.jpeg") no-repeat center center;
      background-size: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .content-wrapper {
      max-width: 960px;
      margin: -60px auto 0;
      background-color: #ffffffee;
      padding: 50px 30px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      text-align: center;
      position: relative;
    }
    h1 {
      color: #1b5e20;
      font-size: 2.2em;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 5px;
      color: #2e7d32;
      text-align: left;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }
    #searchInput {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      max-width: 320px;
      border-radius: 6px;
      border: 1px solid #aaa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 0;
      box-sizing: border-box;
      display: block;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      z-index: 10;
    }
    /* Conteneur suggestions */
    #suggestions {
      position: absolute;
      top: 158px; /* position sous input (300 header + 50 padding + ~8 margin) */
      left: 50%;
      transform: translateX(-50%);
      max-width: 320px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
      z-index: 15;
    }
    #suggestions div {
      padding: 10px;
      cursor: pointer;
      text-align: left;
      font-size: 16px;
    }
    #suggestions div:hover,
    #suggestions .selected {
      background-color: #1b5e20;
      color: white;
    }
    select {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #aaa;
      margin: 15px auto 30px;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: block;
      max-height: 240px;
      overflow-y: auto;
    }
    .meteo-container, .forecast-container {
      display: none;
      background-color: #fafafa;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: 0 auto 30px;
      max-width: 700px;
      text-align: left;
      font-size: 16px;
    }
    .meteo-container img, .forecast-container img {
      vertical-align: middle;
      height: 50px;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    .btn-retour {
      display: inline-block;
      background-color: #1b5e20;
      color: white;
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transition: background-color 0.3s, color 0.3s;
    }
    .btn-retour:hover {
      background-color: #43a047;
      color: #fff176;
    }
    .arrow-anim {
      display: inline-block;
      animation: slideArrow 1.5s infinite ease-in-out;
      margin-right: 8px;
      font-size: 24px;
    }
    @keyframes slideArrow {
      0% { transform: translateX(0); }
      50% { transform: translateX(6px); }
      100% { transform: translateX(0); }
    }

    @keyframes clignote {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }

    .clignotant-marker {
      animation: clignote 1s infinite;
      width: 24px;
      height: 24px;
      background-color: rgb(0, 234, 255); /* Tu peux changer en vert/violet selon le type */
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }

    .refresh-btn {
      margin: 15px 0;
      padding: 10px 18px;
      font-weight: bold;
      background-color: #2e7d32;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .refresh-btn:hover {
      background-color: #1b5e20;
    }
    /* styule pour laffichage au cas ou lutilisateur na pas des donnees */
    #meteoAffiche p {
      padding: 12px;
      background-color: #ffe0e0;
      border: 1px solid #d32f2f;
      color: #b71c1c;
      border-radius: 8px;
      font-weight: bold;
    }

    /* styule pour laffichage au cas ou lutilisateur na pas des donnees */
    .btn-localisation {
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #2e7d32;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .btn-localisation:hover {
      background-color: #1b5e20;
    }

    /* styule pour la fleche de la position actuel */
    .user-position-marker {
      font-size: 24px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.2); opacity: 0.5; }
      100% { transform: scale(1); opacity: 0.9; }
    }

    /* styule du chemin trace */
    .btn-itineraire {
      margin-top: 15px;
      padding: 10px 14px;
      font-size: 16px;
      background-color: #1565c0;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-itineraire:hover {
      background-color: #0d47a1;
    }
      /* styule du lien vers les conseils */
    .lien-conseil {
      margin-top: 20px;
      background: #f0fdf4;
      border-left: 5px solid #2e7d32;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1rem;
      animation: slideIn 0.6s ease-out;
    }
    .lien-conseil a.btn-conseil {
      display: inline-block;
      margin-top: 8px;
      background: #2e7d32;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.3s ease;
    }
    .lien-conseil a.btn-conseil:hover {
      background: #1b5e20;
    }
    @keyframes slideIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="header-image"></div>

  <div class="content-wrapper">
    <h1>M√©t√©o en direct ‚Äì Burkina Faso</h1>
    <p>S√©lectionnez une commune pour obtenir les conditions actuelles et les pr√©visions.</p>

    <label for="searchInput">Rechercher une commune :</label>
    <input type="text" id="searchInput" placeholder="Tapez pour filtrer..." autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false">

    <div id="suggestions" role="listbox" aria-label="Suggestions communes"></div>

    <label for="citySelect">Choisir une commune :</label>
    <select id="citySelect" size="10" aria-label="Liste des communes" onchange="afficherMeteo()">
      <option value="">-- Choisir une commune --</option>
    </select>

    <div id="meteoAffiche" class="meteo-container" role="region" aria-live="polite"></div>
    <div id="forecastAffiche" class="forecast-container">
      <canvas id="chart" aria-label="Graphique des pr√©visions m√©t√©o"></canvas>
    </div>

    <a href="FASOFARMPREDICTBK16.html" class="btn-retour" role="button">
      <span class="arrow-anim">‚¨Ö</span> Retour √† l‚Äôaccueil
    </a>
  
    <label for="regionSelect">Filtrer par r√©gion :</label>
    <select id="regionSelect" onchange="filtrerParRegionEtCarte()">
      <option value="">-- Toutes les r√©gions --</option>
      <option value="Boucle du Mouhoun">Boucle du Mouhoun</option>
      <option value="Cascades">Cascades</option>
      <option value="Centre">Centre</option>
      <option value="Centre-Est">Centre-Est</option>
      <option value="Centre-Nord">Centre-Nord</option>
      <option value="Centre-Ouest">Centre-Ouest</option>
      <option value="Centre-Sud">Centre-Sud</option>
      <option value="Est">Est</option>
      <option value="Hauts-Bassins">Hauts-Bassins</option>
      <option value="Nord">Nord</option>
      <option value="Plateau-Central">Plateau-Central</option>
      <option value="Sahel">Sahel</option>
      <option value="Sud-Ouest">Sud-Ouest</option>
    </select>

    <button id="refreshAll" class="refresh-btn">üîÑ Actualiser toutes les communes</button>
    <label><input type="checkbox" id="forceRefresh"> Forcer la mise √† jour</label>
    <div id="map" style="height: 500px; width: 100%; margin-top: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);"></div>
    
    <a href="conseils.html?commune=ouaga" class="btn-conseils">
      üå± Voir les conseils pour les diffentes communes ainsi que les types de cultures
    </a>
    
    <button id="localisationBtn" class="btn-localisation">
      üìç Afficher la m√©t√©o de ma position actuelle
    </button>

    <button onclick="afficherItineraireVersCommune()" class="btn-itineraire">
      üß≠ Voir l'itin√©raire vers la commune s√©lectionn√©e
    </button>

  </div>

  <script>
    const apiKey = 'ad776ac3bf4773ae87214e499e6328e5';

    const communes = [
      "Arbinda","Bani","Markoye","Tongomayel","Yamba","D√©ou","Pama","Fada N‚ÄôGourma","Diapangou","Matombo",
      "Diapaga","Gorom-Gorom","Djibo","Ouahigouya","Titao","Nouna","D√©dougou","Solenzo","Boromo","Gourcy",
      "Bobo-Dioulasso","Gaoua","Manga","Koudougou","R√©o","Ouagadougou","Kaya","Tenkodogo","Boussouma","Dori",
      "Sebba","Ziniar√©","Boulsa","Kongoussi","Koup√©la","Zorgo","P√¥","Foub√©","Yako","Kantchari","B√©r√©",
      "Aribinda","Boussouma","Banfora","Kongoussi","To√©ni","Di√©bougou","Bagr√©","Toma","Nassoulou","Solhan",
      "Tansarga","Solenzo","Fara","Leo","R√©o","Toma","Kongoussi","Djibo","Manni","Gaoua","Pama","Lorop√©ni",
      "T√©gu√©r√©","Gorom-Gorom","Bati√©","Kaya","Ouahigouya","Tougan","Koup√©la","Di√©bougou","Leo","Banfora",
      "To√©ni","Ouargaye","Tanghin-Dassouri","Titao","Boromo","Tenkodogo","D√©dougou","Koudougou","Ouagadougou",
      "Bobo-Dioulasso","Diapaga","Fada N‚ÄôGourma","Djibo","Solhan","Kantchari","B√©r√©","Bati√©","Tansarga",
      "Nouna","Lorop√©ni","Gaoua","Manni","P√¥","T√©gu√©r√©","Solenzo","Tougan","Ouargaye","Dori","Koup√©la",
      "Markoye","Zorgo","Tanghin-Dassouri","Banfora","Bati√©","Titao","Pama","To√©ni","Diapangou","Sebba",
      "Kantchari","R√©o","Leo","Boromo","Foub√©","B√©r√©","Boussouma","Nassoulou","Solhan","Djibo","Toma",
      "Di√©bougou","Kaya","Tansarga","Ouagadougou","Manni","Koudougou","Dori","Bobo-Dioulasso","Ouahigouya",
      "Fada N‚ÄôGourma","Gorom-Gorom","Koup√©la","D√©dougou","Banfora","Tenkodogo","T√©gu√©r√©","Lorop√©ni","P√¥",
      "Markoye","Solhan","Ziniar√©","Nouna","Kongoussi","To√©ni","Bati√©","Tanghin-Dassouri","Sebba","Foub√©",
      "Yako","B√©r√©","R√©o","Djibo","Toma","Gaoua","Pama","Kaya","Dori","Ouagadougou","Boromo","Solenzo",
      "Tougan","Fara","Boussouma","Ouargaye","Manga","Bobo-Dioulasso","Koup√©la","D√©dougou","Banfora",
      "Diapangou","P√¥","Tansarga","Markoye","Zorgo","Titao","Kongoussi","Toma","Lorop√©ni","Foub√©",
      "T√©gu√©r√©","Sebba","Gorom-Gorom","Koudougou","Kantchari","Nassoulou","Ouahigouya","R√©o","Djibo",
      "Tansarga","Banfora","Fada N‚ÄôGourma","Manni","Solhan","Dori","Ziniar√©","B√©r√©","Ouagadougou","Tenkodogo",
      "Gaoua","Bati√©","Pama","Bobo-Dioulasso","To√©ni","Boussouma","D√©dougou","Kaya","Toma","Koup√©la",
      "Boromo","Foub√©","Ouargaye","Koudougou","Markoye","Sebba","P√¥","Tanghin-Dassouri","Lorop√©ni","Nouna",
      "Tougan","Fara","Djibo","Yako","R√©o","Solenzo","Kantchari","Zorgo","Gorom-Gorom","Titao","Banfora",
      "Fada N‚ÄôGourma","Kongoussi","Tansarga","Dori","B√©r√©","D√©dougou","Manga","Ouahigouya","Bati√©","Kaya",
      "To√©ni","Bobo-Dioulasso","Boussouma","Toma","Nassoulou","Pama","Koup√©la","Boromo","Ouagadougou",
      "Markoye","Koudougou","Sebba","Djibo","Lorop√©ni","Solhan","Gaoua","Tenkodogo","Ziniar√©","Foub√©",
      "Tougan","P√¥","Tanghin-Dassouri","Yako","Titao","R√©o","Kantchari","Ouargaye","D√©dougou","Banfora",
      "Kongoussi","Fada N‚ÄôGourma","Tansarga","B√©r√©","Dori","Djibo","Nouna","Manni","Bati√©","Ouahigouya",
      "Kaya","Bobo-Dioulasso","Toma","Koup√©la","Boromo","Foub√©","Pama","Markoye","Sebba","P√¥","Tougan",
      "Zorgo","Titao","Lorop√©ni","Tenkodogo","Banfora","Fada N‚ÄôGourma","D√©dougou","Ouagadougou","R√©o",
      "Gorom-Gorom","Tansarga","Nassoulou","Dori","Djibo","Koudougou","B√©r√©","Toma","Solhan","Kantchari",
      "Yako","Gaoua","Boussouma","Kaya","To√©ni","Ouahigouya","Bati√©","Pama","Ouargaye","Foub√©","T√©gu√©r√©",
      "Markoye","Manni","Banfora","Ziniar√©","Titao","Tansarga","D√©dougou","Kongoussi","Koup√©la","Fada N‚ÄôGourma",
      "Sebba","Dori","Djibo","B√©r√©","P√¥","Bobo-Dioulasso","R√©o","Tougan","Ouagadougou","Tenkodogo",
      "Fara","Boromo","Koudougou","Nouna","Toma","Gaoua","Yako","Lorop√©ni","Kantchari","Solhan","Pama",
      "Banfora","Gorom-Gorom","D√©dougou","Fada N‚ÄôGourma","Markoye","Boussouma","Tansarga","Bati√©","Titao",
      "Tougan","Ouargaye","Dori","Tansarga","Nassoulou","D√©dougou","Djibo","Kaya","Koup√©la","Toma","Zorgo",
      "Koudougou","Banfora","B√©r√©","Manni","P√¥","Lorop√©ni","Sebba","Ouagadougou","Foub√©","Ouahigouya",
      "Tenkodogo","Gaoua","Pama","Bobo-Dioulasso","T√©gu√©r√©","Titao","Fada N‚ÄôGourma","Djibo","Solhan",
      "R√©o","Markoye","To√©ni","D√©dougou","Banfora","Kongoussi","Koup√©la","Tansarga","Nouna","Ziniar√©","Toma",
      "Kantchari","Yako","Boromo","B√©r√©","Gorom-Gorom","Bat i√©","P√¥","Ouargaye","Foub√©","Tougan","Dori",
      "Sebba","Kaya","Tenkodogo","Ouagadougou","Boussouma","Fada N‚ÄôGourma","Markoye","Djibo","Tansarga","Banfora",
      "Koudougou","D√©dougou","Bobo-Dioulasso","Zorgo","Toma","Koup√©la","Lorop√©ni","Manni","Fara","Pama",
      "Titao","Ouahigouya","Gorom-Gorom","Nouna","B√©r√©","Kantchari","Tansarga","R√©o","Kongoussi","Dori",
      "To√©ni","Banfora","Djibo","Kaya","Fada N‚ÄôGourma","Barsalogho","Bati√©","Boussouma","Sebba","P√¥",
      "Tougan","Foub√©","Markoye","Koudougou","Ziniar√©","Boromo","Tenkodogo","Manga","D√©dougou","Toma",
      "Koup√©la","Ouargaye","Solhan","Tansarga","Fada N‚ÄôGourma","Djibo","Banfora","Kongoussi","Nouna",
      "R√©o","Pama","Yako","Gaoua","Titao","B√©r√©","Kantchari","Tougan","Foub√©","Lorop√©ni","Dori","Bobo-Dioulasso",
      "Ouahigouya","Koudougou","Manni","Tansarga","Ouagadougou","Kaya","Toma","Tenkodogo","Fada N‚ÄôGourma","Djibo",
      "Tougan","Banfora","Bati√©","Toma","D√©dougou","P√¥","Boussouma","Koup√©la","Sebba","Zorgo","Markoye",
      "Nouna","Gaoua","R√©o","T√©gu√©r√©","Foub√©","Ouargaye","Titao","Lorop√©ni","B√©r√©","Kantchari","Fada N‚ÄôGourma",
      "Tansarga","Bobo-Dioulasso","Djibo","Banfora","Dori","Manni","Ouagadougou","Kaya","Koudougou","Tougan",
      "Bati√©","Nouna","Pama","Toma","Koup√©la","D√©dougou","Fada N‚ÄôGourma","Boromo","Tenkodogo","Sebba",
      "Ouahigouya","Markoye","B√©r√©","Ziniar√©","Gaoua","Djibo","Kantchari","To√©ni","R√©o","Banfora","Fada N‚ÄôGourma",
      "Solhan","Tansarga","Dori","Titao","Tenkodogo","Bobo-Dioulasso","P√¥","Toma","Koup√©la","Boussouma","Ouagadougou"
    ];

    // Nettoyage doublons & tri alphab√©tique
    const communesUnique = [...new Set(communes)].sort((a,b) => a.localeCompare(b, 'fr'));

    // El√©ments DOM
    const citySelect = document.getElementById('citySelect');
    const searchInput = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');
    let currentMarkers = [];
    // Remplit le select (toutes communes)
    function remplirCommunes(liste) {
      citySelect.innerHTML = '';
      const optionVide = document.createElement('option');
      optionVide.value = "";
      optionVide.textContent = "-- Choisir une commune --";
      citySelect.appendChild(optionVide);

      liste.forEach(commune => {
        const opt = document.createElement('option');
        opt.value = commune;
        opt.textContent = commune;
        citySelect.appendChild(opt);
      });
    }

    // Filtre et affiche suggestions sous input
    function afficherSuggestions(filtre) {
      const filtred = communesUnique.filter(c => c.toLowerCase().includes(filtre.toLowerCase()));
      suggestions.innerHTML = '';
      if (filtre.trim() === '' || filtred.length === 0) {
        suggestions.style.display = 'none';
        return;
      }
      filtred.slice(0, 10).forEach((commune, idx) => {
        const div = document.createElement('div');
        div.textContent = commune;
        div.setAttribute('role', 'option');
        div.id = 'suggestion-'+idx;
        div.addEventListener('click', () => {
          searchInput.value = commune;
          citySelect.value = commune;
          suggestions.style.display = 'none';
          afficherMeteo();
        });
        suggestions.appendChild(div);
      });
      suggestions.style.display = 'block';
      selectedIndex = -1;
      searchInput.setAttribute('aria-expanded', 'true');
    }

    // Gestion navigation clavier dans suggestions
    let selectedIndex = -1;
    searchInput.addEventListener('keydown', e => {
      const items = suggestions.querySelectorAll('div');
      if (suggestions.style.display === 'block' && items.length > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = (selectedIndex + 1) % items.length;
          majSelection(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          majSelection(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && selectedIndex < items.length) {
            items[selectedIndex].click();
            selectedIndex = -1;
            suggestions.style.display = 'none';
          }
        } else if (e.key === 'Escape') {
          suggestions.style.display = 'none';
          selectedIndex = -1;
          searchInput.setAttribute('aria-expanded', 'false');
        }
      }
    });

    function majSelection(items) {
      items.forEach((item,i) => {
        if (i === selectedIndex) {
          item.classList.add('selected');
          item.setAttribute('aria-selected', 'true');
          searchInput.setAttribute('aria-activedescendant', item.id);
        } else {
          item.classList.remove('selected');
          item.setAttribute('aria-selected', 'false');
        }
      });
    }

    // Masquer suggestions si clic √† l‚Äôext√©rieur
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.style.display = 'none';
        selectedIndex = -1;
        searchInput.setAttribute('aria-expanded', 'false');
      }
    });

    // Au changement de la s√©lection dans le select
    citySelect.addEventListener('change', () => {
      searchInput.value = citySelect.value;
      afficherMeteo();
      suggestions.style.display = 'none';
      selectedIndex = -1;
      searchInput.setAttribute('aria-expanded', 'false');
    });

    // Au changement dans l'input de recherche
    searchInput.addEventListener('input', () => {
      afficherSuggestions(searchInput.value);
      citySelect.value = "";
      document.getElementById('meteoAffiche').style.display = 'none';
      document.getElementById('forecastAffiche').style.display = 'none';
    });

    //       recuperation de mes donnees en format js
    
    // Affichage m√©t√©o + pr√©visions + graphique
    async function afficherMeteo() {
      const city = citySelect.value || searchInput.value;
      const meteoZone = document.getElementById("meteoAffiche");
      const forecastZone = document.getElementById("forecastAffiche");

      if (!city) {
        meteoZone.style.display = "none";
        forecastZone.style.display = "none";
        return;
      }

      const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)},BF&units=metric&lang=fr&appid=${apiKey}`;
      const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)},BF&units=metric&lang=fr&appid=${apiKey}`;

      try {
        const [weatherResp, forecastResp] = await Promise.all([
          fetch(weatherUrl),
          fetch(forecastUrl)
        ]);
        const weatherData = await weatherResp.json();
        const forecastData = await forecastResp.json();

        if (weatherData.cod === 200) {
          meteoZone.innerHTML = `
            <h2>${weatherData.name} ‚Äî ${weatherData.weather[0].description}
              <img src="https://openweathermap.org/img/wn/${weatherData.weather[0].icon}@2x.png" alt="Icone m√©t√©o">
            </h2>
            <ul>
              <li>üå° Temp√©rature : ${weatherData.main.temp.toFixed(1)} ¬∞C</li>
              <li>üíß Humidit√© : ${weatherData.main.humidity}%</li>
              <li>üí® Vent : ${weatherData.wind.speed.toFixed(1)} m/s</li>
              <li>üìà Pression : ${weatherData.main.pressure} hPa</li>
              <li>‚òÅÔ∏è Nuages : ${weatherData.clouds.all}%</li>
            </ul>`;
          meteoZone.style.display = "block";
        } else {
          meteoZone.innerHTML = `<p>Impossible d'obtenir la m√©t√©o pour "${city}".</p>`;
          meteoZone.style.display = "block";
        }

        if (forecastData.cod === "200") {
          const labels = forecastData.list.filter((_, i) => i % 8 === 0).map(f => {
            const date = new Date(f.dt * 1000);
            return `${date.getDate()}/${date.getMonth() + 1}`;
          });

          const tempData = forecastData.list.filter((_, i) => i % 8 === 0).map(f => f.main.temp);

          const ctx = document.getElementById('chart').getContext('2d');
          if(window.myChart) window.myChart.destroy();
          window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Temp√©rature (5 jours)',
                data: tempData,
                borderColor: '#1b5e20',
                backgroundColor: 'rgba(27, 94, 32, 0.2)',
                fill: true,
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: false
                }
              }
            }
          });

          forecastZone.style.display = "block";
        } else {
          forecastZone.style.display = "none";
        }

      } catch (err) {
        if (!navigator.onLine) {
          meteoZone.innerHTML = `<p>üì° Veuillez vous connecter √† Internet pour profiter des donn√©es m√©t√©o.</p>`;
        } else {
          meteoZone.innerHTML = `<p>‚ùóÔ∏èErreur lors de la r√©cup√©ration des donn√©es m√©t√©o. Veuillez r√©essayer plus tard.</p>`;
        }
        meteoZone.style.display = "block";
        forecastZone.style.display = "none";
      }
      // Analyse des pr√©visions pour d√©tecter de la pluie
      const vaPleuvoir = forecastData.list.some(f => f.weather[0].main.toLowerCase().includes("rain"));

      // G√©n√©ration du lien dynamique
      const lienConseil = document.createElement("div");
      lienConseil.classList.add("lien-conseil");

      if (vaPleuvoir) {
        const communeEnc = encodeURIComponent(city);
        lienConseil.innerHTML = `
          <p>üåß Il va pleuvoir demain ?</p>
          <a href="conseils.html?commune=${communeEnc}" class="btn-conseil">
            üëâ Voici les bonnes pratiques de semis üå±
          </a>
        `;
      } else {
        lienConseil.innerHTML = `
          <p>‚úÖ Aucune pluie imminente d√©tect√©e.</p>
          <a href="conseils.html" class="btn-conseil">
            üëâ Acc√©dez aux conseils agricoles adapt√©s
          </a>
        `;
      }
      // Ajoute sous la m√©t√©o
      forecastZone.appendChild(lienConseil);

    }

 
        // Exemple d'association r√©gion -> communes
    const regions = {
      "Boucle du Mouhoun": ["D√©dougou", "Nouna", "Tougan", "Toma", "Solenzo", "Boromo"],
      "Cascades": ["Banfora", "Sindou", "Niangoloko"],
      "Centre": ["Ouagadougou", "Tanghin-Dassouri", "Komsilga", "Saaba"],
      "Centre-Est": ["Tenkodogo", "Koup√©la", "Bittou", "Garango"],
      "Centre-Nord": ["Kaya", "Boussouma", "Pissila", "Tougouri"],
      "Centre-Ouest": ["Koudougou", "R√©o", "L√©o", "Sourgou"],
      "Centre-Sud": ["Manga", "P√¥", "Guiaro"],
      "Est": ["Fada N‚ÄôGourma", "Pama", "Diapaga", "Kantchari"],
      "Hauts-Bassins": ["Bobo-Dioulasso", "Farakoba", "Dand√©", "Hound√©"],
      "Nord": ["Ouahigouya", "Titao", "Gorom-Gorom", "Djibo"],
      "Plateau-Central": ["Ziniar√©", "Zorgho", "Bouss√©"],
      "Sahel": ["Dori", "Sebba", "Gorom-Gorom", "Djibo"],
      "Sud-Ouest": ["Gaoua", "Di√©bougou", "Bati√©", "Kampti"]
    };

    // Met √† jour le menu des communes selon la r√©gion

    // Initialisation de la carte Leaflet
    let map;
    function initCarte() {
      map = L.map('map').setView([12.3714, -1.5197], 6); // Centr√© sur le Burkina Faso

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Donn√©es ¬© OpenStreetMap',
        maxZoom: 18
      }).addTo(map);
    }

    function clearMarkers() {
      currentMarkers.forEach(marker => map.removeLayer(marker));
      currentMarkers = [];
    }

    function addMeteoMarker(data, commune) {
      const clignotantIcon = L.divIcon({
        className: 'clignotant-marker',
        iconSize: [24, 24]
      });

      const marker = L.marker([data.coord.lat, data.coord.lon], {
        icon: clignotantIcon
      }).addTo(map);

      marker.bindPopup(`<b>${commune}</b><br>üå° ${data.main.temp.toFixed(1)} ¬∞C<br>üíß ${data.main.humidity}%`);
      currentMarkers.push(marker);
    }

    // Ajoute les marqueurs m√©t√©o √† la carte
    async function ajouterMarqueurs(communes) {
      if (!map || !communes) return;
      clearMarkers();

      const force = document.getElementById("forceRefresh")?.checked || false;

      for (const commune of communes) {
        const cacheKey = `meteo_${commune}`;
        const cached = sessionStorage.getItem(cacheKey);

        if (cached && !force) {
          const data = JSON.parse(cached);
          addMeteoMarker(data, commune);
        } else {
          const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(commune)},BF&units=metric&lang=fr&appid=${apiKey}`;
          try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.coord) {
              sessionStorage.setItem(cacheKey, JSON.stringify(data));
              addMeteoMarker(data, commune);
            }
          } catch (e) {
            console.warn("Erreur m√©t√©o pour : " + commune);
          }
        }
      }
    }

    
    // filtration de mes region sur la carte
    function filtrerParRegionEtCarte() {
      const region = document.getElementById("regionSelect").value;
      if (region && regions[region]) {
        const communes = regions[region].sort();
        remplirCommunes(communes); // Met √† jour le <select> commune
        ajouterMarqueurs(communes); // Met √† jour la carte
      } else {
        remplirCommunes(communesUnique);
        ajouterMarqueurs(communesUnique.slice(0, 20)); // Ou toutes les communes ?
      }
    }



    // Lance tout √† l‚Äôouverture
    window.onload = () => {
      remplirCommunes(communesUnique);
      initCarte();
      ajouterMarqueurs(communesUnique.slice(0, 20)); // Par d√©faut 20 communes
    };

    document.getElementById("refreshAll").addEventListener("click", () => {
      ajouterMarqueurs(communesUnique.slice(0, 100)); // Tu peux ajuster √† 50, 100 ou + si ton quota le permet
    });

    document.getElementById('localisationBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // Marqueur utilisateur
          const userIcon = L.divIcon({
            className: 'user-position-marker',
            html: '‚û§',
            iconSize: [30, 30]
          });

          const marker = L.marker([lat, lon], { icon: userIcon }).addTo(map);
          map.setView([lat, lon], 9); // Zoom sur la position

          const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=fr&appid=${apiKey}`;

          try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.cod === 200) {
              document.getElementById('meteoAffiche').innerHTML = `
                <h2>üìç ${data.name} ‚Äî ${data.weather[0].description}
                  <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" alt="Icone m√©t√©o">
                </h2>
                <ul>
                  <li>üå° Temp√©rature : ${data.main.temp.toFixed(1)} ¬∞C</li>
                  <li>üíß Humidit√© : ${data.main.humidity}%</li>
                  <li>üí® Vent : ${data.wind.speed.toFixed(1)} m/s</li>
                  <li>üìà Pression : ${data.main.pressure} hPa</li>
                  <li>‚òÅÔ∏è Nuages : ${data.clouds.all}%</li>
                </ul>`;
              document.getElementById('meteoAffiche').style.display = 'block';
            } else {
              document.getElementById('meteoAffiche').innerHTML = `<p>‚ùóÔ∏èDonn√©es m√©t√©o non disponibles pour votre position actuelle.</p>`;
            }
          } catch (e) {
            document.getElementById('meteoAffiche').innerHTML = `<p>‚ùóÔ∏èErreur lors de la r√©cup√©ration m√©t√©o de votre position.</p>`;
          }

        }, () => {
          alert("‚ùóÔ∏è Impossible d'acc√©der √† votre position. Veuillez autoriser la g√©olocalisation.");
        });
      } else {
        alert("Votre navigateur ne prend pas en charge la g√©olocalisation.");
      }
    });

    // Section tracement du chemin a revoir le code secret


    let routingControl; // Variable globale pour g√©rer le trac√©
    const orsApiKey = '5a2f1b30xxxxxxxxxxxxxxxxxxxxxxxx'; // Remplace ici
    async function afficherItineraireVersCommune() {
      if (!navigator.geolocation) {
        alert("‚ùóÔ∏èLa g√©olocalisation n'est pas disponible.");
        return;
      }

      const commune = citySelect.value || searchInput.value;
      if (!commune) {
        alert("‚ùóÔ∏èVeuillez d'abord s√©lectionner une commune.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];

        try {
          // Obtenir les coordonn√©es GPS de la commune s√©lectionn√©e
          const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(commune)},BF&appid=${apiKey}`);
          const data = await response.json();

          if (data && data.coord) {
            const communeLatLng = [data.coord.lat, data.coord.lon];

            // Supprime l'itin√©raire pr√©c√©dent s'il existe
            if (routingControl) {
              map.removeControl(routingControl);
            }

            // Affiche l‚Äôitin√©raire
            routingControl = L.Routing.control({
              waypoints: [
                L.latLng(userLatLng[0], userLatLng[1]),
                L.latLng(communeLatLng[0], communeLatLng[1])
              ],
              lineOptions: {
                styles: [{ color: 'blue', weight: 5 }]
              },
              createMarker: function(i, wp, nWps) {
                return L.marker(wp.latLng, {
                  icon: L.divIcon({ className: 'custom-route-icon', html: i === 0 ? 'üìç' : 'üèòÔ∏è' })
                });
              },
              routeWhileDragging: false,
              show: false,
              addWaypoints: false
            }).addTo(map);

            map.fitBounds(L.latLngBounds([userLatLng, communeLatLng]), { padding: [50, 50] });
          } else {
            alert("‚ùóÔ∏èCommune non trouv√©e pour afficher le trajet.");
          }
        } catch (e) {
          alert("‚ùóÔ∏èErreur lors de la r√©cup√©ration des donn√©es GPS.");
        }
      }, () => {
        alert("‚ùóÔ∏èVeuillez activer la g√©olocalisation pour afficher l'itin√©raire.");
      });
    }

  </script>
  <script>
    // Fonction de pr√©chargement m√©t√©o si param√®tre pr√©sent
    function verifierParametreURL() {
      const params = new URLSearchParams(window.location.search);
      const ville = params.get("ville");

      if (ville) {
        // Remplit le menu commune s'il existe
        const regionKeys = Object.keys(regions);
        for (let region of regionKeys) {
          if (regions[region].includes(capitaliser(ville))) {
            document.getElementById("regionSelect").value = region;
            remplirCommunes(regions[region]);
            document.getElementById("communeSelect").value = ville;
            ajouterMarqueurs([ville]); // Affiche m√©t√©o sur la carte
            chargerGraphiquePrevision(ville); // Affiche pr√©vision si existante
            break;
          }
        }
      }
    }

    // Pour normaliser (optionnel)
    function capitaliser(str) {
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }
    function enregistrerConsultation(commune) {
      const stats = JSON.parse(localStorage.getItem("stats_communes")) || {};
      stats[commune] = (stats[commune] || 0) + 1;
      localStorage.setItem("stats_communes", JSON.stringify(stats));
    }

  </script>
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

</body>
</html>
